function HAll = RotateHessian(Xsin,Omega)
    [N,~]=size(Xsin);
    HAll = zeros(3*N,3); % This is the Hessian of taux for all the vectors
    for k=1:N
        Om1 = Omega(k,1);
        Om2 = Omega(k,2);
        Om3 = Omega(k,3);
        t1 = Xsin(k,1);
        t2 = Xsin(k,2);
        t3 = Xsin(k,3);
        nOm = norm(Omega(k,:));
        if (nOm>1e-8)
        t5 = abs(Om1);
        t6 = abs(Om2);
        t7 = abs(Om3);
        t8 = conj(Om1);
        t9 = conj(Om2);
        t10 = conj(Om3);
        t20 = 1.0./Om1;
        t21 = 1.0./Om2;
        t22 = 1.0./Om3;
        t11 = t5.^2;
        t12 = t6.^2;
        t13 = t7.^2;
        t14 = Om1.*t8;
        t15 = Om2.*t9;
        t16 = Om3.*t10;
        t17 = Om1+t8;
        t18 = Om2+t9;
        t19 = Om3+t10;
        t23 = 1.0./t8;
        t24 = 1.0./t9;
        t25 = 1.0./t10;
        t26 = t17.^2;
        t27 = t18.^2;
        t28 = t19.^2;
        t29 = 1.0./sqrt(t14);
        t31 = 1.0./sqrt(t15);
        t33 = 1.0./sqrt(t16);
        t35 = t11+t12+t13;
        t30 = t29.^3;
        t32 = t31.^3;
        t34 = t33.^3;
        t36 = 1.0./t35;
        t38 = sqrt(t35);
        t37 = t36.^2;
        t39 = cos(t38);
        t40 = sin(t38);
        t41 = 1.0./t38;
        t42 = t41.^3;
        t43 = t41.^5;
        t44 = t1.*t41;
        t45 = t2.*t41;
        t46 = t3.*t41;
        t49 = t39-1.0;
        t110 = (t1.*t5.*t6.*t17.*t18.*t29.*t31.*t36.*t39)./4.0;
        t111 = (t1.*t5.*t7.*t17.*t19.*t29.*t33.*t36.*t39)./4.0;
        t112 = (t1.*t6.*t7.*t18.*t19.*t31.*t33.*t36.*t39)./4.0;
        t47 = Om2.*t46;
        t48 = Om3.*t45;
        t50 = t8.*t44;
        t51 = t9.*t45;
        t52 = t10.*t46;
        t53 = -t44;
        t54 = -t45;
        t55 = -t46;
        t57 = (t2.*t5.*t17.*t29.*t42)./2.0;
        t58 = (t3.*t5.*t17.*t29.*t42)./2.0;
        t59 = (t1.*t6.*t18.*t31.*t42)./2.0;
        t60 = (t2.*t6.*t18.*t31.*t42)./2.0;
        t61 = (t3.*t6.*t18.*t31.*t42)./2.0;
        t62 = (t1.*t7.*t19.*t33.*t42)./2.0;
        t63 = (t2.*t7.*t19.*t33.*t42)./2.0;
        t64 = (t3.*t7.*t19.*t33.*t42)./2.0;
        t78 = (t1.*t5.*t8.*t17.*t29.*t42)./2.0;
        t87 = Om3.*t2.*t5.*t17.*t29.*t42.*(-1.0./2.0);
        t88 = Om2.*t3.*t6.*t18.*t31.*t42.*(-1.0./2.0);
        t89 = Om3.*t2.*t7.*t19.*t33.*t42.*(-1.0./2.0);
        t91 = Om2.*t3.*t5.*t6.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t92 = Om3.*t2.*t5.*t6.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t93 = Om2.*t3.*t5.*t7.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t94 = Om3.*t2.*t5.*t7.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t95 = Om2.*t3.*t6.*t7.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t96 = Om3.*t2.*t6.*t7.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t97 = t1.*t5.*t6.*t8.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t98 = t2.*t5.*t6.*t9.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t99 = t3.*t5.*t6.*t10.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t100 = t1.*t5.*t7.*t8.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t101 = t2.*t5.*t7.*t9.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t102 = t3.*t5.*t7.*t10.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t103 = t1.*t6.*t7.*t8.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t104 = t2.*t6.*t7.*t9.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t105 = t3.*t6.*t7.*t10.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t113 = -t110;
        t114 = -t111;
        t115 = -t112;
        t116 = (t1.*t5.*t6.*t17.*t18.*t29.*t31.*t40.*t42)./4.0;
        t117 = (t1.*t5.*t7.*t17.*t19.*t29.*t33.*t40.*t42)./4.0;
        t118 = (t1.*t6.*t7.*t18.*t19.*t31.*t33.*t40.*t42)./4.0;
        t56 = -t48;
        t65 = -t57;
        t66 = -t58;
        t67 = -t59;
        t68 = -t61;
        t69 = -t62;
        t70 = -t63;
        t71 = -t64;
        t72 = Om2.*t58;
        t75 = Om3.*t60;
        t76 = Om2.*t64;
        t79 = t9.*t57;
        t80 = t10.*t58;
        t81 = t8.*t59;
        t82 = t9.*t60;
        t83 = t10.*t61;
        t84 = t8.*t62;
        t85 = t9.*t63;
        t86 = t10.*t64;
        t106 = -t91;
        t107 = -t94;
        t108 = -t96;
        t109 = t50+t51+t52;
        t90 = t47+t56;
        t119 = t72+t87;
        t120 = t46+t75+t88;
        t121 = t45+t76+t89;
        t134 = (t6.*t18.*t31.*t36.*t40.*t109)./2.0;
        t135 = (t7.*t19.*t33.*t36.*t40.*t109)./2.0;
        t136 = (t6.*t18.*t31.*t42.*t49.*t109)./2.0;
        t137 = (t7.*t19.*t33.*t42.*t49.*t109)./2.0;
        t140 = Om1.*t5.*t6.*t17.*t18.*t29.*t31.*t37.*t40.*t109.*(3.0./4.0);
        t141 = Om1.*t5.*t7.*t17.*t19.*t29.*t33.*t37.*t40.*t109.*(3.0./4.0);
        t142 = Om1.*t6.*t7.*t18.*t19.*t31.*t33.*t37.*t40.*t109.*(3.0./4.0);
        t148 = (Om1.*t5.*t6.*t17.*t18.*t29.*t31.*t39.*t42.*t109)./4.0;
        t149 = (Om1.*t5.*t7.*t17.*t19.*t29.*t33.*t39.*t42.*t109)./4.0;
        t150 = (Om1.*t6.*t7.*t18.*t19.*t31.*t33.*t39.*t42.*t109)./4.0;
        t151 = Om1.*t5.*t6.*t17.*t18.*t29.*t31.*t43.*t49.*t109.*(3.0./4.0);
        t152 = Om1.*t5.*t7.*t17.*t19.*t29.*t33.*t43.*t49.*t109.*(3.0./4.0);
        t153 = Om1.*t6.*t7.*t18.*t19.*t31.*t33.*t43.*t49.*t109.*(3.0./4.0);
        t157 = t53+t78+t79+t80;
        t158 = t54+t81+t82+t83;
        t159 = t55+t84+t85+t86;
        t160 = t58+t92+t106;
        t161 = t57+t93+t107;
        t173 = t60+t71+t95+t108;
        t199 = t65+t67+t97+t98+t99;
        t200 = t66+t69+t100+t101+t102;
        t201 = t68+t70+t103+t104+t105;
        t122 = (t5.*t6.*t17.*t18.*t29.*t31.*t36.*t40.*t90)./4.0;
        t123 = (t5.*t7.*t17.*t19.*t29.*t33.*t36.*t40.*t90)./4.0;
        t124 = (t6.*t7.*t18.*t19.*t31.*t33.*t36.*t40.*t90)./4.0;
        t128 = (t5.*t6.*t17.*t18.*t29.*t31.*t39.*t42.*t90)./4.0;
        t129 = (t5.*t7.*t17.*t19.*t29.*t33.*t39.*t42.*t90)./4.0;
        t130 = (t6.*t7.*t18.*t19.*t31.*t33.*t39.*t42.*t90)./4.0;
        t138 = (t6.*t18.*t31.*t39.*t41.*t119)./2.0;
        t139 = (t7.*t19.*t33.*t39.*t41.*t119)./2.0;
        t145 = -t140;
        t146 = -t141;
        t147 = -t142;
        t154 = -t151;
        t155 = -t152;
        t156 = -t153;
        t162 = (t5.*t17.*t29.*t39.*t41.*t120)./2.0;
        t163 = (t5.*t17.*t29.*t39.*t41.*t121)./2.0;
        t164 = (t7.*t19.*t33.*t39.*t41.*t120)./2.0;
        t165 = (t6.*t18.*t31.*t39.*t41.*t121)./2.0;
        t168 = t40.*t160;
        t169 = t40.*t161;
        t171 = t41.*t49.*t158;
        t172 = t41.*t49.*t159;
        t174 = (Om1.*t6.*t18.*t31.*t36.*t40.*t157)./2.0;
        t175 = (Om1.*t7.*t19.*t33.*t36.*t40.*t157)./2.0;
        t176 = (Om1.*t5.*t17.*t29.*t36.*t40.*t158)./2.0;
        t177 = (Om1.*t7.*t19.*t33.*t36.*t40.*t158)./2.0;
        t178 = (Om1.*t5.*t17.*t29.*t36.*t40.*t159)./2.0;
        t179 = (Om1.*t6.*t18.*t31.*t36.*t40.*t159)./2.0;
        t186 = (Om1.*t6.*t18.*t31.*t42.*t49.*t157)./2.0;
        t187 = (Om1.*t7.*t19.*t33.*t42.*t49.*t157)./2.0;
        t188 = (Om1.*t5.*t17.*t29.*t42.*t49.*t158)./2.0;
        t189 = (Om1.*t7.*t19.*t33.*t42.*t49.*t158)./2.0;
        t190 = (Om1.*t5.*t17.*t29.*t42.*t49.*t159)./2.0;
        t191 = (Om1.*t6.*t18.*t31.*t42.*t49.*t159)./2.0;
        t198 = t40.*t173;
        t202 = Om1.*t41.*t49.*t199;
        t203 = Om1.*t41.*t49.*t200;
        t204 = Om1.*t41.*t49.*t201;
        t125 = -t122;
        t126 = -t123;
        t127 = -t124;
        t131 = -t128;
        t132 = -t129;
        t133 = -t130;
        t143 = -t138;
        t144 = -t139;
        t166 = -t163;
        t167 = -t165;
        t170 = -t168;
        t180 = -t174;
        t181 = -t175;
        t182 = -t176;
        t183 = -t177;
        t184 = -t178;
        t185 = -t179;
        t192 = -t186;
        t193 = -t187;
        t194 = -t188;
        t195 = -t189;
        t196 = -t190;
        t197 = -t191;
        t205 = -t202;
        t206 = -t203;
        t207 = -t204;
        t208 = t115+t118+t127+t133+t147+t150+t156+t164+t167+t183+t185+t195+t197+t198+t207;
        t209 = t114+t117+t126+t132+t135+t137+t144+t146+t149+t155+t166+t169+t172+t181+t184+t193+t196+t206;
        t210 = t113+t116+t125+t131+t134+t136+t143+t145+t148+t154+t162+t170+t171+t180+t182+t192+t194+t205;
        et1 = -t40.*(Om2.*t3.*t5.*t29.*t42-Om3.*t2.*t5.*t29.*t42+(Om2.*t3.*t26.*t29.^2.*t42)./4.0-(Om3.*t2.*t26.*t29.^2.*t42)./4.0-Om2.*t3.*t11.*t26.*t29.^2.*t43.*(3.0./4.0)+Om3.*t2.*t11.*t26.*t29.^2.*t43.*(3.0./4.0)-(Om2.*t3.*t5.*t26.*t30.*t42)./4.0+(Om3.*t2.*t5.*t26.*t30.*t42)./4.0)+t41.*t49.*t157.*2.0+t5.*t29.*t40.*t53-(t26.*t29.^2.*t40.*t44)./4.0;
        et2 = Om1.*t41.*t49.*((t1.*t20.*t26.*t42)./4.0+(t2.*t9.*t26.*t29.^2.*t42)./4.0+(t3.*t10.*t26.*t29.^2.*t42)./4.0+t1.*t5.*t8.*t29.*t42+t2.*t5.*t9.*t29.*t42+t3.*t5.*t10.*t29.*t42+t1.*t5.*t17.*t29.*t42-t1.*t11.*t20.*t26.*t43.*(3.0./4.0)-(t1.*t5.*t8.*t26.*t30.*t42)./4.0-(t2.*t5.*t9.*t26.*t30.*t42)./4.0-(t3.*t5.*t10.*t26.*t30.*t42)./4.0-t2.*t9.*t11.*t26.*t29.^2.*t43.*(3.0./4.0)-t3.*t10.*t11.*t26.*t29.^2.*t43.*(3.0./4.0))+(t26.*t29.^2.*t39.*t41.*t90)./4.0+(t5.*t26.*t30.*t40.*t44)./4.0+t5.*t29.*t39.*t41.*t90+(t23.*t26.*t36.*t40.*t109)./4.0+(t23.*t26.*t42.*t49.*t109)./4.0-(t5.*t26.*t30.*t39.*t41.*t90)./4.0+t5.*t17.*t29.*t36.*t40.*t109;
        et3 = t11.*t23.*t26.*t37.*t40.*t109.*(-3.0./4.0)-t5.*t17.*t29.*t39.*t41.*t119+(t11.*t23.*t26.*t39.*t42.*t109)./4.0+t5.*t17.*t29.*t42.*t49.*t109-t11.*t23.*t26.*t43.*t49.*t109.*(3.0./4.0)-(t1.*t11.*t26.*t29.^2.*t36.*t39)./4.0+(t1.*t11.*t26.*t29.^2.*t40.*t42)./4.0-(t11.*t26.*t29.^2.*t36.*t40.*t90)./4.0-(t11.*t26.*t29.^2.*t39.*t42.*t90)./4.0+Om1.*t5.*t29.*t36.*t40.*t109+Om1.*t5.*t29.*t42.*t49.*t109-(Om1.*t5.*t26.*t30.*t36.*t40.*t109)./4.0-(Om1.*t5.*t26.*t30.*t42.*t49.*t109)./4.0-Om1.*t5.*t17.*t29.*t36.*t40.*t157-Om1.*t5.*t17.*t29.*t42.*t49.*t157;
        et4 = -t40.*((t3.*t24.*t27.*t42)./4.0+Om2.*t3.*t6.*t31.*t42-Om3.*t2.*t6.*t31.*t42+t3.*t6.*t18.*t31.*t42-t3.*t12.*t24.*t27.*t43.*(3.0./4.0)-(Om3.*t2.*t27.*t31.^2.*t42)./4.0+Om3.*t2.*t12.*t27.*t31.^2.*t43.*(3.0./4.0)-(Om2.*t3.*t6.*t27.*t32.*t42)./4.0+(Om3.*t2.*t6.*t27.*t32.*t42)./4.0)+t6.*t31.*t40.*t53-(t27.*t31.^2.*t40.*t44)./4.0;
        et5 = Om1.*t41.*t49.*((t2.*t21.*t27.*t42)./4.0+(t1.*t8.*t27.*t31.^2.*t42)./4.0+(t3.*t10.*t27.*t31.^2.*t42)./4.0+t1.*t6.*t8.*t31.*t42+t2.*t6.*t9.*t31.*t42+t3.*t6.*t10.*t31.*t42+t2.*t6.*t18.*t31.*t42-t2.*t12.*t21.*t27.*t43.*(3.0./4.0)-(t1.*t6.*t8.*t27.*t32.*t42)./4.0-(t2.*t6.*t9.*t27.*t32.*t42)./4.0-(t3.*t6.*t10.*t27.*t32.*t42)./4.0-t1.*t8.*t12.*t27.*t31.^2.*t43.*(3.0./4.0)-t3.*t10.*t12.*t27.*t31.^2.*t43.*(3.0./4.0))+(t27.*t31.^2.*t39.*t41.*t90)./4.0+(t6.*t27.*t32.*t40.*t44)./4.0+t6.*t31.*t39.*t41.*t90-(t6.*t27.*t32.*t39.*t41.*t90)./4.0+t6.*t18.*t31.*t39.*t41.*t120+(Om1.*t27.*t31.^2.*t36.*t40.*t109)./4.0+(Om1.*t27.*t31.^2.*t42.*t49.*t109)./4.0;
        et6 = t1.*t12.*t27.*t31.^2.*t36.*t39.*(-1.0./4.0)+(t1.*t12.*t27.*t31.^2.*t40.*t42)./4.0-(t12.*t27.*t31.^2.*t36.*t40.*t90)./4.0-(t12.*t27.*t31.^2.*t39.*t42.*t90)./4.0+Om1.*t6.*t31.*t36.*t40.*t109+Om1.*t6.*t31.*t42.*t49.*t109-(Om1.*t6.*t27.*t32.*t36.*t40.*t109)./4.0-(Om1.*t6.*t27.*t32.*t42.*t49.*t109)./4.0-Om1.*t6.*t18.*t31.*t36.*t40.*t158-Om1.*t6.*t18.*t31.*t42.*t49.*t158-Om1.*t12.*t27.*t31.^2.*t37.*t40.*t109.*(3.0./4.0)+(Om1.*t12.*t27.*t31.^2.*t39.*t42.*t109)./4.0-Om1.*t12.*t27.*t31.^2.*t43.*t49.*t109.*(3.0./4.0);
        et7 = t40.*((t2.*t25.*t28.*t42)./4.0-Om2.*t3.*t7.*t33.*t42+Om3.*t2.*t7.*t33.*t42+t2.*t7.*t19.*t33.*t42-t2.*t13.*t25.*t28.*t43.*(3.0./4.0)-(Om2.*t3.*t28.*t33.^2.*t42)./4.0+Om2.*t3.*t13.*t28.*t33.^2.*t43.*(3.0./4.0)+(Om2.*t3.*t7.*t28.*t34.*t42)./4.0-(Om3.*t2.*t7.*t28.*t34.*t42)./4.0)+t7.*t33.*t40.*t53-(t28.*t33.^2.*t40.*t44)./4.0;
        et8 = Om1.*t41.*t49.*((t3.*t22.*t28.*t42)./4.0+(t1.*t8.*t28.*t33.^2.*t42)./4.0+(t2.*t9.*t28.*t33.^2.*t42)./4.0+t1.*t7.*t8.*t33.*t42+t2.*t7.*t9.*t33.*t42+t3.*t7.*t10.*t33.*t42+t3.*t7.*t19.*t33.*t42-t3.*t13.*t22.*t28.*t43.*(3.0./4.0)-(t1.*t7.*t8.*t28.*t34.*t42)./4.0-(t2.*t7.*t9.*t28.*t34.*t42)./4.0-(t3.*t7.*t10.*t28.*t34.*t42)./4.0-t1.*t8.*t13.*t28.*t33.^2.*t43.*(3.0./4.0)-t2.*t9.*t13.*t28.*t33.^2.*t43.*(3.0./4.0))+(t28.*t33.^2.*t39.*t41.*t90)./4.0+(t7.*t28.*t34.*t40.*t44)./4.0+t7.*t33.*t39.*t41.*t90-(t7.*t28.*t34.*t39.*t41.*t90)./4.0-t7.*t19.*t33.*t39.*t41.*t121+(Om1.*t28.*t33.^2.*t36.*t40.*t109)./4.0+(Om1.*t28.*t33.^2.*t42.*t49.*t109)./4.0;
        et9 = t1.*t13.*t28.*t33.^2.*t36.*t39.*(-1.0./4.0)+(t1.*t13.*t28.*t33.^2.*t40.*t42)./4.0-(t13.*t28.*t33.^2.*t36.*t40.*t90)./4.0-(t13.*t28.*t33.^2.*t39.*t42.*t90)./4.0+Om1.*t7.*t33.*t36.*t40.*t109+Om1.*t7.*t33.*t42.*t49.*t109-(Om1.*t7.*t28.*t34.*t36.*t40.*t109)./4.0-(Om1.*t7.*t28.*t34.*t42.*t49.*t109)./4.0-Om1.*t7.*t19.*t33.*t36.*t40.*t159-Om1.*t7.*t19.*t33.*t42.*t49.*t159-Om1.*t13.*t28.*t33.^2.*t37.*t40.*t109.*(3.0./4.0)+(Om1.*t13.*t28.*t33.^2.*t39.*t42.*t109)./4.0-Om1.*t13.*t28.*t33.^2.*t43.*t49.*t109.*(3.0./4.0);
        H1 = reshape([et1+et2+et3,t210,t209,t210,et4+et5+et6,t208,t209,t208,et7+et8+et9],[3,3]);
        
        
        t5 = abs(Om1);
        t6 = abs(Om2);
        t7 = abs(Om3);
        t8 = conj(Om1);
        t9 = conj(Om2);
        t10 = conj(Om3);
        t20 = 1.0./Om1;
        t21 = 1.0./Om2;
        t22 = 1.0./Om3;
        t11 = t5.^2;
        t12 = t6.^2;
        t13 = t7.^2;
        t14 = Om1.*t8;
        t15 = Om2.*t9;
        t16 = Om3.*t10;
        t17 = Om1+t8;
        t18 = Om2+t9;
        t19 = Om3+t10;
        t23 = 1.0./t8;
        t24 = 1.0./t9;
        t25 = 1.0./t10;
        t26 = t17.^2;
        t27 = t18.^2;
        t28 = t19.^2;
        t29 = 1.0./sqrt(t14);
        t31 = 1.0./sqrt(t15);
        t33 = 1.0./sqrt(t16);
        t35 = t11+t12+t13;
        t30 = t29.^3;
        t32 = t31.^3;
        t34 = t33.^3;
        t36 = 1.0./t35;
        t38 = sqrt(t35);
        t37 = t36.^2;
        t39 = cos(t38);
        t40 = sin(t38);
        t41 = 1.0./t38;
        t42 = t41.^3;
        t43 = t41.^5;
        t44 = t1.*t41;
        t45 = t2.*t41;
        t46 = t3.*t41;
        t49 = t39-1.0;
        t110 = (t2.*t5.*t6.*t17.*t18.*t29.*t31.*t36.*t39)./4.0;
        t111 = (t2.*t5.*t7.*t17.*t19.*t29.*t33.*t36.*t39)./4.0;
        t112 = (t2.*t6.*t7.*t18.*t19.*t31.*t33.*t36.*t39)./4.0;
        t47 = Om1.*t46;
        t48 = Om3.*t44;
        t50 = t8.*t44;
        t51 = t9.*t45;
        t52 = t10.*t46;
        t53 = -t44;
        t54 = -t45;
        t55 = -t46;
        t57 = (t1.*t5.*t17.*t29.*t42)./2.0;
        t58 = (t2.*t5.*t17.*t29.*t42)./2.0;
        t59 = (t3.*t5.*t17.*t29.*t42)./2.0;
        t60 = (t1.*t6.*t18.*t31.*t42)./2.0;
        t61 = (t3.*t6.*t18.*t31.*t42)./2.0;
        t62 = (t1.*t7.*t19.*t33.*t42)./2.0;
        t63 = (t2.*t7.*t19.*t33.*t42)./2.0;
        t64 = (t3.*t7.*t19.*t33.*t42)./2.0;
        t82 = (t2.*t6.*t9.*t18.*t31.*t42)./2.0;
        t87 = Om1.*t3.*t5.*t17.*t29.*t42.*(-1.0./2.0);
        t88 = Om3.*t1.*t6.*t18.*t31.*t42.*(-1.0./2.0);
        t89 = Om3.*t1.*t7.*t19.*t33.*t42.*(-1.0./2.0);
        t91 = Om1.*t3.*t5.*t6.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t92 = Om3.*t1.*t5.*t6.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t93 = Om1.*t3.*t5.*t7.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t94 = Om3.*t1.*t5.*t7.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t95 = Om1.*t3.*t6.*t7.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t96 = Om3.*t1.*t6.*t7.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t97 = t1.*t5.*t6.*t8.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t98 = t2.*t5.*t6.*t9.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t99 = t3.*t5.*t6.*t10.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t100 = t1.*t5.*t7.*t8.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t101 = t2.*t5.*t7.*t9.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t102 = t3.*t5.*t7.*t10.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t103 = t1.*t6.*t7.*t8.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t104 = t2.*t6.*t7.*t9.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t105 = t3.*t6.*t7.*t10.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t113 = -t110;
        t114 = -t111;
        t115 = -t112;
        t116 = (t2.*t5.*t6.*t17.*t18.*t29.*t31.*t40.*t42)./4.0;
        t117 = (t2.*t5.*t7.*t17.*t19.*t29.*t33.*t40.*t42)./4.0;
        t118 = (t2.*t6.*t7.*t18.*t19.*t31.*t33.*t40.*t42)./4.0;
        t56 = -t48;
        t65 = -t58;
        t66 = -t59;
        t67 = -t60;
        t68 = -t61;
        t69 = -t62;
        t70 = -t63;
        t71 = -t64;
        t73 = Om3.*t57;
        t74 = Om1.*t61;
        t76 = Om1.*t64;
        t78 = t8.*t57;
        t79 = t9.*t58;
        t80 = t10.*t59;
        t81 = t8.*t60;
        t83 = t10.*t61;
        t84 = t8.*t62;
        t85 = t9.*t63;
        t86 = t10.*t64;
        t106 = -t91;
        t107 = -t94;
        t108 = -t96;
        t109 = t50+t51+t52;
        t90 = t47+t56;
        t119 = t74+t88;
        t120 = t46+t73+t87;
        t121 = t44+t76+t89;
        t128 = (t5.*t17.*t29.*t36.*t40.*t109)./2.0;
        t129 = (t7.*t19.*t33.*t36.*t40.*t109)./2.0;
        t130 = (t5.*t17.*t29.*t42.*t49.*t109)./2.0;
        t131 = (t7.*t19.*t33.*t42.*t49.*t109)./2.0;
        t134 = Om2.*t5.*t6.*t17.*t18.*t29.*t31.*t37.*t40.*t109.*(3.0./4.0);
        t135 = Om2.*t5.*t7.*t17.*t19.*t29.*t33.*t37.*t40.*t109.*(3.0./4.0);
        t136 = Om2.*t6.*t7.*t18.*t19.*t31.*t33.*t37.*t40.*t109.*(3.0./4.0);
        t140 = (Om2.*t5.*t6.*t17.*t18.*t29.*t31.*t39.*t42.*t109)./4.0;
        t141 = (Om2.*t5.*t7.*t17.*t19.*t29.*t33.*t39.*t42.*t109)./4.0;
        t142 = (Om2.*t6.*t7.*t18.*t19.*t31.*t33.*t39.*t42.*t109)./4.0;
        t143 = Om2.*t5.*t6.*t17.*t18.*t29.*t31.*t43.*t49.*t109.*(3.0./4.0);
        t144 = Om2.*t5.*t7.*t17.*t19.*t29.*t33.*t43.*t49.*t109.*(3.0./4.0);
        t145 = Om2.*t6.*t7.*t18.*t19.*t31.*t33.*t43.*t49.*t109.*(3.0./4.0);
        t149 = t53+t78+t79+t80;
        t150 = t54+t81+t82+t83;
        t151 = t55+t84+t85+t86;
        t152 = t61+t92+t106;
        t153 = t60+t95+t108;
        t165 = t57+t71+t93+t107;
        t192 = t65+t67+t97+t98+t99;
        t193 = t66+t69+t100+t101+t102;
        t194 = t68+t70+t103+t104+t105;
        t122 = (t5.*t6.*t17.*t18.*t29.*t31.*t36.*t40.*t90)./4.0;
        t123 = (t5.*t7.*t17.*t19.*t29.*t33.*t36.*t40.*t90)./4.0;
        t124 = (t6.*t7.*t18.*t19.*t31.*t33.*t36.*t40.*t90)./4.0;
        t125 = (t5.*t6.*t17.*t18.*t29.*t31.*t39.*t42.*t90)./4.0;
        t126 = (t5.*t7.*t17.*t19.*t29.*t33.*t39.*t42.*t90)./4.0;
        t127 = (t6.*t7.*t18.*t19.*t31.*t33.*t39.*t42.*t90)./4.0;
        t132 = (t5.*t17.*t29.*t39.*t41.*t119)./2.0;
        t133 = (t7.*t19.*t33.*t39.*t41.*t119)./2.0;
        t137 = -t134;
        t138 = -t135;
        t139 = -t136;
        t146 = -t143;
        t147 = -t144;
        t148 = -t145;
        t154 = (t6.*t18.*t31.*t39.*t41.*t120)./2.0;
        t155 = (t7.*t19.*t33.*t39.*t41.*t120)./2.0;
        t156 = (t5.*t17.*t29.*t39.*t41.*t121)./2.0;
        t157 = (t6.*t18.*t31.*t39.*t41.*t121)./2.0;
        t160 = t40.*t152;
        t161 = t40.*t153;
        t163 = t41.*t49.*t149;
        t164 = t41.*t49.*t151;
        t166 = (Om2.*t6.*t18.*t31.*t36.*t40.*t149)./2.0;
        t167 = (Om2.*t7.*t19.*t33.*t36.*t40.*t149)./2.0;
        t168 = (Om2.*t5.*t17.*t29.*t36.*t40.*t150)./2.0;
        t169 = (Om2.*t7.*t19.*t33.*t36.*t40.*t150)./2.0;
        t170 = (Om2.*t5.*t17.*t29.*t36.*t40.*t151)./2.0;
        t171 = (Om2.*t6.*t18.*t31.*t36.*t40.*t151)./2.0;
        t178 = (Om2.*t6.*t18.*t31.*t42.*t49.*t149)./2.0;
        t179 = (Om2.*t7.*t19.*t33.*t42.*t49.*t149)./2.0;
        t180 = (Om2.*t5.*t17.*t29.*t42.*t49.*t150)./2.0;
        t181 = (Om2.*t7.*t19.*t33.*t42.*t49.*t150)./2.0;
        t182 = (Om2.*t5.*t17.*t29.*t42.*t49.*t151)./2.0;
        t183 = (Om2.*t6.*t18.*t31.*t42.*t49.*t151)./2.0;
        t190 = t40.*t165;
        t195 = Om2.*t41.*t49.*t192;
        t196 = Om2.*t41.*t49.*t193;
        t197 = Om2.*t41.*t49.*t194;
        t158 = -t154;
        t159 = -t155;
        t162 = -t161;
        t172 = -t166;
        t173 = -t167;
        t174 = -t168;
        t175 = -t169;
        t176 = -t170;
        t177 = -t171;
        t184 = -t178;
        t185 = -t179;
        t186 = -t180;
        t187 = -t181;
        t188 = -t182;
        t189 = -t183;
        t191 = -t190;
        t198 = -t195;
        t199 = -t196;
        t200 = -t197;
        t201 = t114+t117+t123+t126+t138+t141+t147+t156+t159+t173+t176+t185+t188+t191+t199;
        t202 = t113+t116+t122+t125+t128+t130+t132+t137+t140+t146+t158+t160+t163+t172+t174+t184+t186+t198;
        t203 = t115+t118+t124+t127+t129+t131+t133+t139+t142+t148+t157+t162+t164+t175+t177+t187+t189+t200;
        et1 = t40.*((t3.*t23.*t26.*t42)./4.0+Om1.*t3.*t5.*t29.*t42-Om3.*t1.*t5.*t29.*t42+t3.*t5.*t17.*t29.*t42-t3.*t11.*t23.*t26.*t43.*(3.0./4.0)-(Om3.*t1.*t26.*t29.^2.*t42)./4.0+Om3.*t1.*t11.*t26.*t29.^2.*t43.*(3.0./4.0)-(Om1.*t3.*t5.*t26.*t30.*t42)./4.0+(Om3.*t1.*t5.*t26.*t30.*t42)./4.0)+t5.*t29.*t40.*t54-(t26.*t29.^2.*t40.*t45)./4.0;
        et2 = Om2.*t41.*t49.*((t1.*t20.*t26.*t42)./4.0+(t2.*t9.*t26.*t29.^2.*t42)./4.0+(t3.*t10.*t26.*t29.^2.*t42)./4.0+t1.*t5.*t8.*t29.*t42+t2.*t5.*t9.*t29.*t42+t3.*t5.*t10.*t29.*t42+t1.*t5.*t17.*t29.*t42-t1.*t11.*t20.*t26.*t43.*(3.0./4.0)-(t1.*t5.*t8.*t26.*t30.*t42)./4.0-(t2.*t5.*t9.*t26.*t30.*t42)./4.0-(t3.*t5.*t10.*t26.*t30.*t42)./4.0-t2.*t9.*t11.*t26.*t29.^2.*t43.*(3.0./4.0)-t3.*t10.*t11.*t26.*t29.^2.*t43.*(3.0./4.0))-(t26.*t29.^2.*t39.*t41.*t90)./4.0+(t5.*t26.*t30.*t40.*t45)./4.0-t5.*t29.*t39.*t41.*t90+(t5.*t26.*t30.*t39.*t41.*t90)./4.0-t5.*t17.*t29.*t39.*t41.*t120+(Om2.*t26.*t29.^2.*t36.*t40.*t109)./4.0+(Om2.*t26.*t29.^2.*t42.*t49.*t109)./4.0;
        et3 = t2.*t11.*t26.*t29.^2.*t36.*t39.*(-1.0./4.0)+(t2.*t11.*t26.*t29.^2.*t40.*t42)./4.0+(t11.*t26.*t29.^2.*t36.*t40.*t90)./4.0+(t11.*t26.*t29.^2.*t39.*t42.*t90)./4.0+Om2.*t5.*t29.*t36.*t40.*t109+Om2.*t5.*t29.*t42.*t49.*t109-(Om2.*t5.*t26.*t30.*t36.*t40.*t109)./4.0-(Om2.*t5.*t26.*t30.*t42.*t49.*t109)./4.0-Om2.*t5.*t17.*t29.*t36.*t40.*t149-Om2.*t5.*t17.*t29.*t42.*t49.*t149-Om2.*t11.*t26.*t29.^2.*t37.*t40.*t109.*(3.0./4.0)+(Om2.*t11.*t26.*t29.^2.*t39.*t42.*t109)./4.0-Om2.*t11.*t26.*t29.^2.*t43.*t49.*t109.*(3.0./4.0);
        et4 = t40.*(Om1.*t3.*t6.*t31.*t42-Om3.*t1.*t6.*t31.*t42+(Om1.*t3.*t27.*t31.^2.*t42)./4.0-(Om3.*t1.*t27.*t31.^2.*t42)./4.0-Om1.*t3.*t12.*t27.*t31.^2.*t43.*(3.0./4.0)+Om3.*t1.*t12.*t27.*t31.^2.*t43.*(3.0./4.0)-(Om1.*t3.*t6.*t27.*t32.*t42)./4.0+(Om3.*t1.*t6.*t27.*t32.*t42)./4.0)+t41.*t49.*t150.*2.0+t6.*t31.*t40.*t54-(t27.*t31.^2.*t40.*t45)./4.0;
        et5 = Om2.*t41.*t49.*((t2.*t21.*t27.*t42)./4.0+(t1.*t8.*t27.*t31.^2.*t42)./4.0+(t3.*t10.*t27.*t31.^2.*t42)./4.0+t1.*t6.*t8.*t31.*t42+t2.*t6.*t9.*t31.*t42+t3.*t6.*t10.*t31.*t42+t2.*t6.*t18.*t31.*t42-t2.*t12.*t21.*t27.*t43.*(3.0./4.0)-(t1.*t6.*t8.*t27.*t32.*t42)./4.0-(t2.*t6.*t9.*t27.*t32.*t42)./4.0-(t3.*t6.*t10.*t27.*t32.*t42)./4.0-t1.*t8.*t12.*t27.*t31.^2.*t43.*(3.0./4.0)-t3.*t10.*t12.*t27.*t31.^2.*t43.*(3.0./4.0))-(t27.*t31.^2.*t39.*t41.*t90)./4.0+(t6.*t27.*t32.*t40.*t45)./4.0-t6.*t31.*t39.*t41.*t90+(t24.*t27.*t36.*t40.*t109)./4.0+(t24.*t27.*t42.*t49.*t109)./4.0+(t6.*t27.*t32.*t39.*t41.*t90)./4.0+t6.*t18.*t31.*t36.*t40.*t109;
        et6 = t12.*t24.*t27.*t37.*t40.*t109.*(-3.0./4.0)+(t12.*t24.*t27.*t39.*t42.*t109)./4.0+t6.*t18.*t31.*t39.*t41.*t119+t6.*t18.*t31.*t42.*t49.*t109-t12.*t24.*t27.*t43.*t49.*t109.*(3.0./4.0)-(t2.*t12.*t27.*t31.^2.*t36.*t39)./4.0+(t2.*t12.*t27.*t31.^2.*t40.*t42)./4.0+(t12.*t27.*t31.^2.*t36.*t40.*t90)./4.0+(t12.*t27.*t31.^2.*t39.*t42.*t90)./4.0+Om2.*t6.*t31.*t36.*t40.*t109+Om2.*t6.*t31.*t42.*t49.*t109-(Om2.*t6.*t27.*t32.*t36.*t40.*t109)./4.0-(Om2.*t6.*t27.*t32.*t42.*t49.*t109)./4.0-Om2.*t6.*t18.*t31.*t36.*t40.*t150-Om2.*t6.*t18.*t31.*t42.*t49.*t150;
        et7 = -t40.*((t1.*t25.*t28.*t42)./4.0-Om1.*t3.*t7.*t33.*t42+Om3.*t1.*t7.*t33.*t42+t1.*t7.*t19.*t33.*t42-t1.*t13.*t25.*t28.*t43.*(3.0./4.0)-(Om1.*t3.*t28.*t33.^2.*t42)./4.0+Om1.*t3.*t13.*t28.*t33.^2.*t43.*(3.0./4.0)+(Om1.*t3.*t7.*t28.*t34.*t42)./4.0-(Om3.*t1.*t7.*t28.*t34.*t42)./4.0)+t7.*t33.*t40.*t54-(t28.*t33.^2.*t40.*t45)./4.0;
        et8 = Om2.*t41.*t49.*((t3.*t22.*t28.*t42)./4.0+(t1.*t8.*t28.*t33.^2.*t42)./4.0+(t2.*t9.*t28.*t33.^2.*t42)./4.0+t1.*t7.*t8.*t33.*t42+t2.*t7.*t9.*t33.*t42+t3.*t7.*t10.*t33.*t42+t3.*t7.*t19.*t33.*t42-t3.*t13.*t22.*t28.*t43.*(3.0./4.0)-(t1.*t7.*t8.*t28.*t34.*t42)./4.0-(t2.*t7.*t9.*t28.*t34.*t42)./4.0-(t3.*t7.*t10.*t28.*t34.*t42)./4.0-t1.*t8.*t13.*t28.*t33.^2.*t43.*(3.0./4.0)-t2.*t9.*t13.*t28.*t33.^2.*t43.*(3.0./4.0))-(t28.*t33.^2.*t39.*t41.*t90)./4.0+(t7.*t28.*t34.*t40.*t45)./4.0-t7.*t33.*t39.*t41.*t90+(t7.*t28.*t34.*t39.*t41.*t90)./4.0+t7.*t19.*t33.*t39.*t41.*t121+(Om2.*t28.*t33.^2.*t36.*t40.*t109)./4.0+(Om2.*t28.*t33.^2.*t42.*t49.*t109)./4.0;
        et9 = t2.*t13.*t28.*t33.^2.*t36.*t39.*(-1.0./4.0)+(t2.*t13.*t28.*t33.^2.*t40.*t42)./4.0+(t13.*t28.*t33.^2.*t36.*t40.*t90)./4.0+(t13.*t28.*t33.^2.*t39.*t42.*t90)./4.0+Om2.*t7.*t33.*t36.*t40.*t109+Om2.*t7.*t33.*t42.*t49.*t109-(Om2.*t7.*t28.*t34.*t36.*t40.*t109)./4.0-(Om2.*t7.*t28.*t34.*t42.*t49.*t109)./4.0-Om2.*t7.*t19.*t33.*t36.*t40.*t151-Om2.*t7.*t19.*t33.*t42.*t49.*t151-Om2.*t13.*t28.*t33.^2.*t37.*t40.*t109.*(3.0./4.0)+(Om2.*t13.*t28.*t33.^2.*t39.*t42.*t109)./4.0-Om2.*t13.*t28.*t33.^2.*t43.*t49.*t109.*(3.0./4.0);
        H2 = reshape([et1+et2+et3,t202,t201,t202,et4+et5+et6,t203,t201,t203,et7+et8+et9],[3,3]);
        
        t5 = abs(Om1);
        t6 = abs(Om2);
        t7 = abs(Om3);
        t8 = conj(Om1);
        t9 = conj(Om2);
        t10 = conj(Om3);
        t20 = 1.0./Om1;
        t21 = 1.0./Om2;
        t22 = 1.0./Om3;
        t11 = t5.^2;
        t12 = t6.^2;
        t13 = t7.^2;
        t14 = Om1.*t8;
        t15 = Om2.*t9;
        t16 = Om3.*t10;
        t17 = Om1+t8;
        t18 = Om2+t9;
        t19 = Om3+t10;
        t23 = 1.0./t8;
        t24 = 1.0./t9;
        t25 = 1.0./t10;
        t26 = t17.^2;
        t27 = t18.^2;
        t28 = t19.^2;
        t29 = 1.0./sqrt(t14);
        t31 = 1.0./sqrt(t15);
        t33 = 1.0./sqrt(t16);
        t35 = t11+t12+t13;
        t30 = t29.^3;
        t32 = t31.^3;
        t34 = t33.^3;
        t36 = 1.0./t35;
        t38 = sqrt(t35);
        t37 = t36.^2;
        t39 = cos(t38);
        t40 = sin(t38);
        t41 = 1.0./t38;
        t42 = t41.^3;
        t43 = t41.^5;
        t44 = t1.*t41;
        t45 = t2.*t41;
        t46 = t3.*t41;
        t49 = t39-1.0;
        t110 = (t3.*t5.*t6.*t17.*t18.*t29.*t31.*t36.*t39)./4.0;
        t111 = (t3.*t5.*t7.*t17.*t19.*t29.*t33.*t36.*t39)./4.0;
        t112 = (t3.*t6.*t7.*t18.*t19.*t31.*t33.*t36.*t39)./4.0;
        t47 = Om1.*t45;
        t48 = Om2.*t44;
        t50 = t8.*t44;
        t51 = t9.*t45;
        t52 = t10.*t46;
        t53 = -t44;
        t54 = -t45;
        t55 = -t46;
        t57 = (t1.*t5.*t17.*t29.*t42)./2.0;
        t58 = (t2.*t5.*t17.*t29.*t42)./2.0;
        t59 = (t3.*t5.*t17.*t29.*t42)./2.0;
        t60 = (t1.*t6.*t18.*t31.*t42)./2.0;
        t61 = (t2.*t6.*t18.*t31.*t42)./2.0;
        t62 = (t3.*t6.*t18.*t31.*t42)./2.0;
        t63 = (t1.*t7.*t19.*t33.*t42)./2.0;
        t64 = (t2.*t7.*t19.*t33.*t42)./2.0;
        t86 = (t3.*t7.*t10.*t19.*t33.*t42)./2.0;
        t87 = Om1.*t2.*t5.*t17.*t29.*t42.*(-1.0./2.0);
        t88 = Om2.*t1.*t6.*t18.*t31.*t42.*(-1.0./2.0);
        t89 = Om2.*t1.*t7.*t19.*t33.*t42.*(-1.0./2.0);
        t91 = Om1.*t2.*t5.*t6.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t92 = Om2.*t1.*t5.*t6.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t93 = Om1.*t2.*t5.*t7.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t94 = Om2.*t1.*t5.*t7.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t95 = Om1.*t2.*t6.*t7.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t96 = Om2.*t1.*t6.*t7.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t97 = t1.*t5.*t6.*t8.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t98 = t2.*t5.*t6.*t9.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t99 = t3.*t5.*t6.*t10.*t17.*t18.*t29.*t31.*t43.*(3.0./4.0);
        t100 = t1.*t5.*t7.*t8.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t101 = t2.*t5.*t7.*t9.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t102 = t3.*t5.*t7.*t10.*t17.*t19.*t29.*t33.*t43.*(3.0./4.0);
        t103 = t1.*t6.*t7.*t8.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t104 = t2.*t6.*t7.*t9.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t105 = t3.*t6.*t7.*t10.*t18.*t19.*t31.*t33.*t43.*(3.0./4.0);
        t113 = -t110;
        t114 = -t111;
        t115 = -t112;
        t116 = (t3.*t5.*t6.*t17.*t18.*t29.*t31.*t40.*t42)./4.0;
        t117 = (t3.*t5.*t7.*t17.*t19.*t29.*t33.*t40.*t42)./4.0;
        t118 = (t3.*t6.*t7.*t18.*t19.*t31.*t33.*t40.*t42)./4.0;
        t56 = -t48;
        t65 = -t58;
        t66 = -t59;
        t67 = -t60;
        t68 = -t61;
        t69 = -t62;
        t70 = -t63;
        t71 = -t64;
        t73 = Om2.*t57;
        t74 = Om1.*t61;
        t76 = Om1.*t64;
        t78 = t8.*t57;
        t79 = t9.*t58;
        t80 = t10.*t59;
        t81 = t8.*t60;
        t82 = t9.*t61;
        t83 = t10.*t62;
        t84 = t8.*t63;
        t85 = t9.*t64;
        t106 = -t92;
        t107 = -t93;
        t108 = -t96;
        t109 = t50+t51+t52;
        t90 = t47+t56;
        t119 = t76+t89;
        t120 = t45+t73+t87;
        t121 = t44+t74+t88;
        t134 = (t5.*t17.*t29.*t36.*t40.*t109)./2.0;
        t135 = (t6.*t18.*t31.*t36.*t40.*t109)./2.0;
        t136 = (t5.*t17.*t29.*t42.*t49.*t109)./2.0;
        t137 = (t6.*t18.*t31.*t42.*t49.*t109)./2.0;
        t140 = Om3.*t5.*t6.*t17.*t18.*t29.*t31.*t37.*t40.*t109.*(3.0./4.0);
        t141 = Om3.*t5.*t7.*t17.*t19.*t29.*t33.*t37.*t40.*t109.*(3.0./4.0);
        t142 = Om3.*t6.*t7.*t18.*t19.*t31.*t33.*t37.*t40.*t109.*(3.0./4.0);
        t148 = (Om3.*t5.*t6.*t17.*t18.*t29.*t31.*t39.*t42.*t109)./4.0;
        t149 = (Om3.*t5.*t7.*t17.*t19.*t29.*t33.*t39.*t42.*t109)./4.0;
        t150 = (Om3.*t6.*t7.*t18.*t19.*t31.*t33.*t39.*t42.*t109)./4.0;
        t151 = Om3.*t5.*t6.*t17.*t18.*t29.*t31.*t43.*t49.*t109.*(3.0./4.0);
        t152 = Om3.*t5.*t7.*t17.*t19.*t29.*t33.*t43.*t49.*t109.*(3.0./4.0);
        t153 = Om3.*t6.*t7.*t18.*t19.*t31.*t33.*t43.*t49.*t109.*(3.0./4.0);
        t157 = t53+t78+t79+t80;
        t158 = t54+t81+t82+t83;
        t159 = t55+t84+t85+t86;
        t160 = t64+t94+t107;
        t161 = t63+t95+t108;
        t173 = t57+t68+t91+t106;
        t199 = t65+t67+t97+t98+t99;
        t200 = t66+t70+t100+t101+t102;
        t201 = t69+t71+t103+t104+t105;
        t122 = (t5.*t6.*t17.*t18.*t29.*t31.*t36.*t40.*t90)./4.0;
        t123 = (t5.*t7.*t17.*t19.*t29.*t33.*t36.*t40.*t90)./4.0;
        t124 = (t6.*t7.*t18.*t19.*t31.*t33.*t36.*t40.*t90)./4.0;
        t128 = (t5.*t6.*t17.*t18.*t29.*t31.*t39.*t42.*t90)./4.0;
        t129 = (t5.*t7.*t17.*t19.*t29.*t33.*t39.*t42.*t90)./4.0;
        t130 = (t6.*t7.*t18.*t19.*t31.*t33.*t39.*t42.*t90)./4.0;
        t138 = (t5.*t17.*t29.*t39.*t41.*t119)./2.0;
        t139 = (t6.*t18.*t31.*t39.*t41.*t119)./2.0;
        t145 = -t140;
        t146 = -t141;
        t147 = -t142;
        t154 = -t151;
        t155 = -t152;
        t156 = -t153;
        t162 = (t6.*t18.*t31.*t39.*t41.*t120)./2.0;
        t163 = (t5.*t17.*t29.*t39.*t41.*t121)./2.0;
        t164 = (t7.*t19.*t33.*t39.*t41.*t120)./2.0;
        t165 = (t7.*t19.*t33.*t39.*t41.*t121)./2.0;
        t168 = t40.*t160;
        t169 = t40.*t161;
        t171 = t41.*t49.*t157;
        t172 = t41.*t49.*t158;
        t174 = (Om3.*t6.*t18.*t31.*t36.*t40.*t157)./2.0;
        t175 = (Om3.*t7.*t19.*t33.*t36.*t40.*t157)./2.0;
        t176 = (Om3.*t5.*t17.*t29.*t36.*t40.*t158)./2.0;
        t177 = (Om3.*t7.*t19.*t33.*t36.*t40.*t158)./2.0;
        t178 = (Om3.*t5.*t17.*t29.*t36.*t40.*t159)./2.0;
        t179 = (Om3.*t6.*t18.*t31.*t36.*t40.*t159)./2.0;
        t186 = (Om3.*t6.*t18.*t31.*t42.*t49.*t157)./2.0;
        t187 = (Om3.*t7.*t19.*t33.*t42.*t49.*t157)./2.0;
        t188 = (Om3.*t5.*t17.*t29.*t42.*t49.*t158)./2.0;
        t189 = (Om3.*t7.*t19.*t33.*t42.*t49.*t158)./2.0;
        t190 = (Om3.*t5.*t17.*t29.*t42.*t49.*t159)./2.0;
        t191 = (Om3.*t6.*t18.*t31.*t42.*t49.*t159)./2.0;
        t198 = t40.*t173;
        t202 = Om3.*t41.*t49.*t199;
        t203 = Om3.*t41.*t49.*t200;
        t204 = Om3.*t41.*t49.*t201;
        t125 = -t122;
        t126 = -t123;
        t127 = -t124;
        t131 = -t128;
        t132 = -t129;
        t133 = -t130;
        t143 = -t138;
        t144 = -t139;
        t166 = -t163;
        t167 = -t165;
        t170 = -t168;
        t180 = -t174;
        t181 = -t175;
        t182 = -t176;
        t183 = -t177;
        t184 = -t178;
        t185 = -t179;
        t192 = -t186;
        t193 = -t187;
        t194 = -t188;
        t195 = -t189;
        t196 = -t190;
        t197 = -t191;
        t205 = -t202;
        t206 = -t203;
        t207 = -t204;
        t208 = t113+t116+t125+t131+t145+t148+t154+t162+t166+t180+t182+t192+t194+t198+t205;
        t209 = t115+t118+t127+t133+t135+t137+t144+t147+t150+t156+t167+t169+t172+t183+t185+t195+t197+t207;
        t210 = t114+t117+t126+t132+t134+t136+t143+t146+t149+t155+t164+t170+t171+t181+t184+t193+t196+t206;
        et1 = -t40.*((t2.*t23.*t26.*t42)./4.0+Om1.*t2.*t5.*t29.*t42-Om2.*t1.*t5.*t29.*t42+t2.*t5.*t17.*t29.*t42-t2.*t11.*t23.*t26.*t43.*(3.0./4.0)-(Om2.*t1.*t26.*t29.^2.*t42)./4.0+Om2.*t1.*t11.*t26.*t29.^2.*t43.*(3.0./4.0)-(Om1.*t2.*t5.*t26.*t30.*t42)./4.0+(Om2.*t1.*t5.*t26.*t30.*t42)./4.0)+t5.*t29.*t40.*t55-(t26.*t29.^2.*t40.*t46)./4.0;
        et2 = Om3.*t41.*t49.*((t1.*t20.*t26.*t42)./4.0+(t2.*t9.*t26.*t29.^2.*t42)./4.0+(t3.*t10.*t26.*t29.^2.*t42)./4.0+t1.*t5.*t8.*t29.*t42+t2.*t5.*t9.*t29.*t42+t3.*t5.*t10.*t29.*t42+t1.*t5.*t17.*t29.*t42-t1.*t11.*t20.*t26.*t43.*(3.0./4.0)-(t1.*t5.*t8.*t26.*t30.*t42)./4.0-(t2.*t5.*t9.*t26.*t30.*t42)./4.0-(t3.*t5.*t10.*t26.*t30.*t42)./4.0-t2.*t9.*t11.*t26.*t29.^2.*t43.*(3.0./4.0)-t3.*t10.*t11.*t26.*t29.^2.*t43.*(3.0./4.0))+(t26.*t29.^2.*t39.*t41.*t90)./4.0+(t5.*t26.*t30.*t40.*t46)./4.0+t5.*t29.*t39.*t41.*t90-(t5.*t26.*t30.*t39.*t41.*t90)./4.0+t5.*t17.*t29.*t39.*t41.*t120+(Om3.*t26.*t29.^2.*t36.*t40.*t109)./4.0+(Om3.*t26.*t29.^2.*t42.*t49.*t109)./4.0;
        et3 = t3.*t11.*t26.*t29.^2.*t36.*t39.*(-1.0./4.0)+(t3.*t11.*t26.*t29.^2.*t40.*t42)./4.0-(t11.*t26.*t29.^2.*t36.*t40.*t90)./4.0-(t11.*t26.*t29.^2.*t39.*t42.*t90)./4.0+Om3.*t5.*t29.*t36.*t40.*t109+Om3.*t5.*t29.*t42.*t49.*t109-(Om3.*t5.*t26.*t30.*t36.*t40.*t109)./4.0-(Om3.*t5.*t26.*t30.*t42.*t49.*t109)./4.0-Om3.*t5.*t17.*t29.*t36.*t40.*t157-Om3.*t5.*t17.*t29.*t42.*t49.*t157-Om3.*t11.*t26.*t29.^2.*t37.*t40.*t109.*(3.0./4.0)+(Om3.*t11.*t26.*t29.^2.*t39.*t42.*t109)./4.0-Om3.*t11.*t26.*t29.^2.*t43.*t49.*t109.*(3.0./4.0);
        et4 = t40.*((t1.*t24.*t27.*t42)./4.0-Om1.*t2.*t6.*t31.*t42+Om2.*t1.*t6.*t31.*t42+t1.*t6.*t18.*t31.*t42-t1.*t12.*t24.*t27.*t43.*(3.0./4.0)-(Om1.*t2.*t27.*t31.^2.*t42)./4.0+Om1.*t2.*t12.*t27.*t31.^2.*t43.*(3.0./4.0)+(Om1.*t2.*t6.*t27.*t32.*t42)./4.0-(Om2.*t1.*t6.*t27.*t32.*t42)./4.0)+t6.*t31.*t40.*t55-(t27.*t31.^2.*t40.*t46)./4.0;
        et5 = Om3.*t41.*t49.*((t2.*t21.*t27.*t42)./4.0+(t1.*t8.*t27.*t31.^2.*t42)./4.0+(t3.*t10.*t27.*t31.^2.*t42)./4.0+t1.*t6.*t8.*t31.*t42+t2.*t6.*t9.*t31.*t42+t3.*t6.*t10.*t31.*t42+t2.*t6.*t18.*t31.*t42-t2.*t12.*t21.*t27.*t43.*(3.0./4.0)-(t1.*t6.*t8.*t27.*t32.*t42)./4.0-(t2.*t6.*t9.*t27.*t32.*t42)./4.0-(t3.*t6.*t10.*t27.*t32.*t42)./4.0-t1.*t8.*t12.*t27.*t31.^2.*t43.*(3.0./4.0)-t3.*t10.*t12.*t27.*t31.^2.*t43.*(3.0./4.0))+(t27.*t31.^2.*t39.*t41.*t90)./4.0+(t6.*t27.*t32.*t40.*t46)./4.0+t6.*t31.*t39.*t41.*t90-(t6.*t27.*t32.*t39.*t41.*t90)./4.0-t6.*t18.*t31.*t39.*t41.*t121+(Om3.*t27.*t31.^2.*t36.*t40.*t109)./4.0+(Om3.*t27.*t31.^2.*t42.*t49.*t109)./4.0;
        et6 = t3.*t12.*t27.*t31.^2.*t36.*t39.*(-1.0./4.0)+(t3.*t12.*t27.*t31.^2.*t40.*t42)./4.0-(t12.*t27.*t31.^2.*t36.*t40.*t90)./4.0-(t12.*t27.*t31.^2.*t39.*t42.*t90)./4.0+Om3.*t6.*t31.*t36.*t40.*t109+Om3.*t6.*t31.*t42.*t49.*t109-(Om3.*t6.*t27.*t32.*t36.*t40.*t109)./4.0-(Om3.*t6.*t27.*t32.*t42.*t49.*t109)./4.0-Om3.*t6.*t18.*t31.*t36.*t40.*t158-Om3.*t6.*t18.*t31.*t42.*t49.*t158-Om3.*t12.*t27.*t31.^2.*t37.*t40.*t109.*(3.0./4.0)+(Om3.*t12.*t27.*t31.^2.*t39.*t42.*t109)./4.0-Om3.*t12.*t27.*t31.^2.*t43.*t49.*t109.*(3.0./4.0);
        et7 = -t40.*(Om1.*t2.*t7.*t33.*t42-Om2.*t1.*t7.*t33.*t42+(Om1.*t2.*t28.*t33.^2.*t42)./4.0-(Om2.*t1.*t28.*t33.^2.*t42)./4.0-Om1.*t2.*t13.*t28.*t33.^2.*t43.*(3.0./4.0)+Om2.*t1.*t13.*t28.*t33.^2.*t43.*(3.0./4.0)-(Om1.*t2.*t7.*t28.*t34.*t42)./4.0+(Om2.*t1.*t7.*t28.*t34.*t42)./4.0)+t41.*t49.*t159.*2.0+t7.*t33.*t40.*t55-(t28.*t33.^2.*t40.*t46)./4.0;
        et8 = Om3.*t41.*t49.*((t3.*t22.*t28.*t42)./4.0+(t1.*t8.*t28.*t33.^2.*t42)./4.0+(t2.*t9.*t28.*t33.^2.*t42)./4.0+t1.*t7.*t8.*t33.*t42+t2.*t7.*t9.*t33.*t42+t3.*t7.*t10.*t33.*t42+t3.*t7.*t19.*t33.*t42-t3.*t13.*t22.*t28.*t43.*(3.0./4.0)-(t1.*t7.*t8.*t28.*t34.*t42)./4.0-(t2.*t7.*t9.*t28.*t34.*t42)./4.0-(t3.*t7.*t10.*t28.*t34.*t42)./4.0-t1.*t8.*t13.*t28.*t33.^2.*t43.*(3.0./4.0)-t2.*t9.*t13.*t28.*t33.^2.*t43.*(3.0./4.0))+(t28.*t33.^2.*t39.*t41.*t90)./4.0+(t7.*t28.*t34.*t40.*t46)./4.0+t7.*t33.*t39.*t41.*t90+(t25.*t28.*t36.*t40.*t109)./4.0+(t25.*t28.*t42.*t49.*t109)./4.0-(t7.*t28.*t34.*t39.*t41.*t90)./4.0+t7.*t19.*t33.*t36.*t40.*t109;
        et9 = t13.*t25.*t28.*t37.*t40.*t109.*(-3.0./4.0)+(t13.*t25.*t28.*t39.*t42.*t109)./4.0-t7.*t19.*t33.*t39.*t41.*t119+t7.*t19.*t33.*t42.*t49.*t109-t13.*t25.*t28.*t43.*t49.*t109.*(3.0./4.0)-(t3.*t13.*t28.*t33.^2.*t36.*t39)./4.0+(t3.*t13.*t28.*t33.^2.*t40.*t42)./4.0-(t13.*t28.*t33.^2.*t36.*t40.*t90)./4.0-(t13.*t28.*t33.^2.*t39.*t42.*t90)./4.0+Om3.*t7.*t33.*t36.*t40.*t109+Om3.*t7.*t33.*t42.*t49.*t109-(Om3.*t7.*t28.*t34.*t36.*t40.*t109)./4.0-(Om3.*t7.*t28.*t34.*t42.*t49.*t109)./4.0-Om3.*t7.*t19.*t33.*t36.*t40.*t159-Om3.*t7.*t19.*t33.*t42.*t49.*t159;
        H3 = reshape([et1+et2+et3,t208,t210,t208,et4+et5+et6,t209,t210,t209,et7+et8+et9],[3,3]);
        else
        % Taylor series
        H1_11 = 1/3*(Om3*t2 - Om2*t3);
        H1_12 = 1/6*(3*t2 - 2*Om1*t3);
        H1_13 = 1/6*(2*Om1*t2 + 3*t3);
        H1_22 = 1/6*(-6*t1 - 4*Om2*t3 + 2*(Om3*t2 - Om2*t3));
        H1_23 = 1/6*(2*Om2*t2 - 2*Om3*t3);
        H1_33 = 1/6*(-6*t1 + 4*Om3*t2 + 2*(Om3*t2 - Om2*t3));
        H1 = [H1_11 H1_12 H1_13; H1_12 H1_22 H1_23; H1_13 H1_23 H1_33];
        
        H2_11 = 1/6*(-6*t2 + 4*Om1*t3 + 2*(-Om3*t1 + Om1*t3));
        H2_12 = 1/6*(3*t1 + 2*Om2*t3);
        H2_13 = 1/6*(-2*Om1*t1 + 2*Om3*t3);
        H2_22 = 1/3*(-Om3*t1 + Om1*t3);
        H2_23 = 1/6*(-2*Om2*t1 + 3*t3);
        H2_33 = 1/6*(-4*Om3*t1 - 6*t2 + 2*(-Om3*t1 + Om1*t3));
        H2 = [H2_11 H2_12 H2_13; H2_12 H2_22 H2_23; H2_13 H2_23 H2_33];
        
        H3_11 = 1/6*(-4*Om1*t2 + 2*(Om2*t1 - Om1*t2) - 6*t3);
        H3_12 = 1/6*(2*Om1*t1 - 2*Om2*t2);
        H3_13 = 1/6*(3*t1 - 2*Om3*t2);
        H3_22 = 1/6*(4*Om2*t1 + 2*(Om2*t1 - Om1*t2) - 6*t3);
        H3_23 = 1/6*(2*Om3*t1 + 3*t2);
        H3_33 = 1/3*(Om2*t1 - Om1*t2);
        H3 = [H3_11 H3_12 H3_13; H3_12 H3_22 H3_23; H3_13 H3_23 H3_33];
        end
        HAll(3*(k-1)+1:3*k,3*(k-1)+1:3*k,1)=H1;
        HAll(3*(k-1)+1:3*k,3*(k-1)+1:3*k,2)=H2;
        HAll(3*(k-1)+1:3*k,3*(k-1)+1:3*k,3)=H3;
    end
end
